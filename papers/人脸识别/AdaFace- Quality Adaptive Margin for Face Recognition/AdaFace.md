# AdaFace: Quality Adaptive Margin for Face Recognition

## Abstract
以前人脸识别的loss函数引入了自适应loss来提高对hard样本的判别能力。本文引入另一种适应性方向，也就是图像质量。本文主张针对误分类样本的强调策略应该根据它们各自的图像质量来调整。因此提出一个新的loss函数，可以根据样本的图像质量对它们进行强调。具体采用adaptive margin函数的形式，通过特征模长对图像质量进行近似的方式实现。

## 1. Introduction
想要设计一个loss函数，它可以根据图像不同质量分配不同的重要性。目的是强调高质量图像的重要性，同时降低低质量样本的重要性。以前的方法通过监视训练过程实现，例如curriculum learning. 本文提出，重要性的分配应同时考虑训练难度以及图像质量。

应该根据图像质量分配重要性的原因在于，如果只是简单的增强困难样本，则会过于强调无法识别图像的重要性，而这些图像总是出现在困难样本中。要在目标函数中引入图像质量信息是有一定难度的，因为图像质量这个概念本身难以定义和量化。


本文的实现方式主要基于两点：
1. 特征的模长能够较好的代表图像质量
2. 不同的margin函数会对不同难度的样本分配不同的重要性

将这两点整合到一起就得到了一个统一的loss函数，AdaFace，他可以根据图像质量适应性地调整margin函数来匹配不同难度的样本。

本文主要贡献：
1. 提出一个loss函数，AdaFace，它根据图像样本的质量来分配重要性。通过结合图像质量信息，避免了对无法识别图像进行增强而关注与可识别的困难样本。
2. 证实了角度margin对梯度进行缩放的依据是训练样本的难度。这一现象促使我们对高质量的困难样本提升重要性，同时忽略质量低的特别困难的样本（无法识别的那种）
3. 展示了特征模长可以作为图像质量的量化指标。

## 2. Related Work
**Adaptive Loss Functions.** 很多算法都在训练的目标函数中引入了自适应元素，其目的要么是困难样本挖掘、训练阶段的难度调度，要么是为了寻找最优超参数。例如CurricularFace就把课程学习的思想加入到loss函数中。在训练的初始阶段，将余弦边界设为较小的值，使网络学习简单样本，然后增大该边界令网络学习困难样本。因此在CurricularFace中，边界的自适应性质是基于训练进程的（所谓课程）。

但是我们主张边界的适应性质应基于图像质量。我们相信在高质量图像中，如果一个样本是困难样本（对于一个特定模型而言），那么网络就应该学习探索这张图象中的信息，但是在低质量图像中，困难样本更应该被忽略。


## 3. Proposed Approach
### 3.1. Margin Form and the Gradient
之前关于基于margin的softmax loss都关注于margin如何改变决策边界以及它们的几何解释。本节说明在反向传播过程中，由于margin对调整样本相对重要性有影响，因此会导致梯度的变化。也就是角度margin会在梯度公式中引入一个额外的项，它可以根据样本的难度调整信号强度。

### 3.2. Norm and Image Quality
图像质量是一个很复杂的概念。本文使用特征模长作为图像质量的代表。观察到对于使用margin-based softmax loss进行训练的模型，其特征模长有一种和图像质量相关的趋势。

### 3.3. AdaFace: Adaptive Margin based on Norm
为了解决由无法识别图像造成的问题，提出修改基于特征模长的的margin函数。

**Image Quality Indicator.** 由于特征模长$\lVert z_i \rVert$是一个与模型无关的量，因此用batch 统计量$\mu_z$和$\sigma_z$来对它进行标准化，令：
$$
\widehat{\lVert z_i \rVert}=\left \lfloor \frac{\lVert z_i \rVert-\mu_z}{\sigma_z/h} \right \rceil^1_{-1}
$$
其中$\mu,\sigma$分别是同一batch的均值和标准差，$\lfloor \cdot \rceil$代表限制取值范围为-1到1并阻止梯度传播。因为中间的标准化分式使$\widehat{\lVert z_i \rVert}$的分布接近于单位高斯分布，因此将值限制在-1到1之间。