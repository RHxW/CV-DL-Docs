# LIME

## Abstract
提出低光照图像增强算法LIME，先根据三通道最大值估计每个像素的光照值，然后在这个初始光照图基础上通过加入一个结构的先验进行优化得到最终光照图。有了构建好的光照图，就可以进行相应的增强操作。

## 1. Introduction
直接放大图片亮度的方法算是最直接最简单的提升暗处可见度的方法。但是这种操作会引起额外的问题，比如较亮区域会失真。直方图均衡化(histogram equalization, HE)策略通过将输出限制在0到1之间来避免上述问题。其他的一些变体引入不同的正则项来提升HE算法性能。但是这些方法本质上关注于对比增强而非探索真实光照的成因，也就有过度增强和欠增强的风险。另一种方法是Gamma修正，它是一种作用于图像上的非线性操作。主要的缺陷是这种非线性操作是独立作用于每一个像素上的，没有考虑到周边相关性，因此增强效果不好。

Retinex理论主要假设图片可以分解为两部分：反射和光照。早期基于Retinex理论的方法将反射图作为最后的增强结果，但是它通常看起来不自然而且经常是过增强的。有的方法在保留自然光照的同时对对比度进行增强，这种方法可以防止过增强现象。

## 2. Methodology
本方法机遇Retinex理论，对于低光照图片，可以表示为：
$$
L=R\circ T \qquad (1)
$$
其中L和R是原图像和目标修复图像，T代表光照图，$\circ$是元素对应相乘。本文首先假设对于彩色图片，三通道共享相同的光照图。上式有很明确的物理意义，观测图像可以分解为目标光照增强结果和光照图乘积的形式。

![Figure 3](3.png "Figure 3")

这个模型和本征图像分解类似，后者的目标是将输入分解为两部分。但是本征图像分解的目标是从原图复原得到反射部分和明暗部分，从Figure 3(b)中可以看到，反射部分丢失了盒子形状信息，因此不适合于低光照图像增强任务。我们期望的效果是获取暗光区域的视觉语义信息，同时保持图像在视觉上的真实性，如Figure 3(c)中样例。有人注意到使用反射图作为增强结果引起不真实的效果是因为尝试将修正后的光照图映射回修正后的反射图，而且因为分解问题本身是不适定的，所以就需要很多先验条件来约束解空间。但是假如只是增强低光照图像，这也是本文关注的任务，则不需要将图像分解成两部分，因为根据公式(1)有$R=L/T$，这里的除法也是元素对应相除。显然T的估计是修正R的关键，这样就将问题简化了，只需要估计T就可以。需要注意，$L/\hat{T}$可以直接作为光照增强的结果。

### A. Illumination Map Estimation
Max-RGB算法是最早的color constancy方法之一，该方法通过寻找三个通道的最大值来估计光照，但是这种方法只能增强全局的光照。为了能够处理不均匀的光照，本文中对每个像素x我们采取了如下的初始估计：
$$
\hat{T}(x) \leftarrow \max_{c\in \{R,G,B\}} L^c(x) \qquad (2)
$$

上述操作背后的原理是：某个点的光照值至少是三通道的最大值。得到的$\hat{T}(x)$可以保证复原操作不饱和，因为：
$$
R(x)=L(x)/(\max_c L^c(x)+\epsilon) \qquad(3)
$$

其中$\epsilon$用于防止溢出。需要指出的是，这里的目的是低光图像的不均匀光照增强，而非去除光源造成的颜色偏差。

另一个广泛使用的模型基于低光照图片的反转图$1-L$与有雾图片很类似:
$$
1-L=(1-R)\circ \tilde{T}+\alpha (1-\tilde{T}) \qquad(4)
$$

其中的$\alpha$代表大气光。尽管反转图像$1-L$看起来和有雾图片很相似，但是和模型(1)相比，这个方法的物理意义并不明确。接下来我们将会展示(4)和(1)之间的联系。

首先回忆一下暗通道先验，这是一个去雾方法常用的估计雾分布图的先验，对于$1-L$这张“有雾”图像，有：
$$
\tilde{T}(x)\leftarrow 1- \min_c{\frac{1-L^c(x)}{a}}=1-\frac{1}{a} + \max_c{\frac{L^c(x)}{a}} \qquad (5)
$$

将(5)带入(4)有：
$$
R(x)=\frac{L(x)-1+a}{(1-\frac{1}{a}+\max_c{\frac{L^c(x)}{a}}+\epsilon)}+(1-a) \qquad(6)
$$
可见，当a=1时，(3)和(6)能够得到相同的结果，但是当a不是1的时候二者的结果就不同了。从Figure 4中可以看到，当a为0.95的时候二者的差异就很明显了。与Figure 4(c)相比，Figure 4(b)中的暗区增强效果较差。
![Figure 4](4.png 'Figure 4')

本作中使用(2)来初始化估计的光照图$\hat{T}$，因为这样做比较简单。还有很多方法可以提升精度，大多数通过考虑光照的局部一致性（像素的小范围区域）实现，其中有两种有代表性的方法：
$$
\tilde{T}\leftarrow \max_{y\in \Omega(x)} \max_{c\in \{R, G, B\}}L^c(y);\\
\tilde{T}\leftarrow \mathop{\text{mean}}\limits_{y\in \Omega(x)} \max_{c\in \{R, G, B\}}L^c(y);
$$
其中$\Omega(x)$是以像素点x为中心的一个区域，y是这个区域中的位置下标。这些方案可以增强局部的一致性，但是它们无法感知图像中的结构信息。下面介绍一个更强的方案。

一个好的方法应该能够在同时保留整体结构同时对纹理细节进行平滑。为了解决这一问题，在初始光照图$\hat{T}$上提出解决如下的优化问题：
$$
\min_T\lVert \hat{T}-T\rVert_F^2+\alpha \lVert W \circ \nabla T \rVert_1 \qquad(8)
$$
其中$\alpha$是调整系数，$\lVert \cdot \rVert_F$和$\lVert \cdot \rVert_1$分别是Frobenious和l1归一化（Frobenious归一化是矩阵所有元素的平方和开根号），W是权重矩阵，$\nabla T$是一阶导滤波器，本文只用水平和垂直两种滤波器。上式中的第一项用来保证初始光照图$\hat{T}$和修正后光照图T间的保真性，第二项对应结构感知平滑度。接下来在探讨构建W的策略之前，先给出上式的两个解法。

### B. Exact Solver to Problem(8)
一般来说，问题（8）可以用alternating direction minimization technique的方法直接求解。用G代表$\nabla T$，有：
$$
\min_{T,G}\lVert \hat{T}-T\rVert_F^2+\alpha \lVert W \circ G \rVert_1 \quad \text{s.t.}\quad \nabla T=G \qquad(9)
$$
上式的扩展的拉格朗日函数形式如下：
$$
\mathcal{L}=\lVert \hat{T}-T\rVert_F^2+\alpha \lVert W \circ G \rVert_1+\Phi (Z,\nabla T-G), \qquad (10)
$$

根据定义$\Phi (Z,\nabla T-G)=\frac{\mu}{2}\lVert \nabla T-G \rVert_F^2+\langle Z,\nabla T-G \rangle$,其中$\langle \cdot, \cdot \rangle$代表矩阵内积，$\mu$是正的惩罚系数，Z是拉格朗日乘数。因此有T，G和Z三个变量需要求解。ALM技术常用于对问题（8）进行求解，每次更新一个变量值而固定其他的，每一步都有一个闭式解。为了方便分析和比较当前和后一步的解，提出如下子问题的解法：

**T sub-problem:** 获取公式（10）中T得方法：
$$
T^{(t+1)}\leftarrow \argmin_T\lVert \hat{T}-T\rVert_F^2+\Phi (Z^{(t)},\nabla T-G^{(t)}) \qquad(11)
$$
