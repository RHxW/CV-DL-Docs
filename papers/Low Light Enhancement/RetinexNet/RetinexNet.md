# RetinexNet

## Abstract
Retinex模型是用于低光照图像增强的有效工具。它假设观测图像可以分解为反射部分和光照部分。大多数机遇Retinex理论的方法都有经过仔细设计的人为约束和参数，因为这种分解本身是高度不适定的(highly ill-posed)，从而可能受限于多样化场景。本文收集了低光照数据集(LOL)，包含低光照和正常光照的数据对，并且提出一个深度Retinex-Net，由一个Decom-Net和一个Enhance-Net组成，分别对应分解和光照调整功能。在Decom-Net的训练过程中没有分解后的反射和光照的gt数据，这个网络仅通过关键约束进行学习，包括在不同光照图片对之间保持一致的反射信息，以及光照的平滑特性。在分解的基础之上，后续的光照增强操作使用一个增强网络，成为Enhance-Net，通过光照进行引导实现光照增强。

## 1. Introduction
有很多导致光照不足的原因，比如低光照环境、摄像设备的性能限制以及设备参数设置不合理等。低光照增强的目的就是为了发掘出隐藏在图片中的细节信息，提升视觉系统的性能。

已有的方法如histogram equalization及其变体通过抑制输入图像的直方图来实现某种约束，还有基于去雾的方法利用反转图像和原图间在光照不足和有雾环境下的关系实现增强。

另一种低光照增强的方法是基于Retinex理论，该理论假设观测到的彩色图片可以分解为反射部分和光照部分。Single-scale Retinex(SSR)方法使用高斯滤波器对光照图进行平滑约束，Multi-scale Retinex(MSRCR)利用多尺度高斯滤波器和色彩修复对SSR进行扩展。

这些方法虽然可以在某些场景下得到较好效果，但它们仍受限于模型的分解能力。因此，设计一个适用于多样化场景下分解的约束较为困难。而且分解后光照图的处理是手动进行的，性能依赖于参数的调整。

为了解决这些问题，提出一个数据驱动的Retinex分解方法，Retinex-Net是一个深度网络，它整合了图像分解和后续的增强操作。首先，使用一个子网络Decom-Net对图片进行分解，得到光照无关的反射部分和结构感知的平滑光照部分。这个Decom-Net通过两个约束进行学习，第一个是低光照和正常光照的图片对，它们的反射部分是一致的，第二个是光照图应该是平滑的，但同时应该保留主要的结构信息，通过一个结构感知的loss获取。然后用一个Enhance-Net来对光照图进行调整，目的是保持较大区域的光照一致性，同时对局部光照分布进行调整，通过多尺度拼接实现。由于较暗区域的噪声通常较大，而且噪声还会被增强过程进一步方法，因此在反射部分引入去噪操作。为了训练这个去噪网络，构建了一个数据集，包含低光照和正常光照的图片对。

## 2 Retinex-Net for Low-Light Enhancement
经典Retinex理论对人类的色彩感知进行建模，它假设观测到的图像可以分解成两部分：反射和光照。令S代表原图，则可以表示为：
$$
S=R \circ I \qquad (1)
$$
其中R代表反射，I代表光照，$\circ$代表对应像素相乘。反射描述了图片中捕捉到物体的内在属性，这种属性在任何光照环境下都应该保持一致。光照则代表物体上的多种光照情况。对于低光照图片，通常受黑暗和光照分布不均的影响。

受Retinex理论影响，设计了Retinex-Net，用于进行反射/光照分解以及低光照增强。该网络有三个步骤：分解、校正和重建。在分解步骤中，Retinex-Net用一个Decom-Net将输入图片分解为R和I，训练时需要成对数据。利用反射在不同光照下应保持一致的特点作为约束，Decom-Net学习在不同光照图片中提取一致的R. 在校正步骤中，用一个Enhance-Net对光照图进行修正，这个Enhance-Net采用encoder-decoder结构。使用一个多尺度拼接的方法实现在利用注意力对局部光照分布进行调整的同时，保持较大区域中包含语义信息的光照的全局一致性。此外，在反射中移除噪声，通常出现在低光照情境下。然后在重建阶段将校正后的光照和反射通过元素相乘的方法进行融合。

![Figure 1](1.png 'Figure 1')

### 2.1 Data-Driven Image Decomposition
对图像进行分解的一种方式是利用人工设计的约束直接估计反射和光照。由于公式(1)高度不适定，因此设计一个合适多种场景的约束函数并不容易，所以尝试通过一种数据驱动的方式来解决这一问题。

在训练阶段，Decom-Net进行学习的依据是不同光照下的图片对共享一致的反射信息。在训练阶段不需要提供反射和光照部分的gt，需要的知识只有反射的一致性以及光照图的平滑性，作为loss函数嵌入在网络之中。因此，网络的分解能力是从成对图像中自动学习到的，而且天然适合描述不同光照场景间的光照变化。

需要注意的一件事是尽管这一问题在形式上也许和本征图像分解类似，但是它们在本质上是不同的。我们的任务不需要精确获取实际的本征图像，而是得到一个用于光照校正的较好的表达。因此，令网络学习寻找低光照图片和它对应增强结果间一致的部分。

如Figure 1所示Decom-Net分别接受低光照图片和正常光照图片作为输入，并且生成各自对应的反射和光照。用CNN将RGB图像映射到反射和光照。

Loss函数由三部分组成：重建loss$\mathcal{L}_{recon}$，一致反射loss$\mathcal{L}_{ir}$和光照平滑loss$\mathcal{L}_{is}$:
$$
\mathcal{L}=\mathcal{L}_{recon}+\lambda_{ir}\mathcal{L}_{ir}+\lambda_{is}\mathcal{L}_{is}
$$
根据假设，$R_{low}$和$R_{high}$都可以用对应的光照图重建原图，所以重建loss$\mathcal{L}_{recon}$公式为：
$$
\mathcal{L}_{recon}=\sum_{i=low, normal}\sum_{j=low,normal}\lambda_{ij}\lVert R_i \circ I_j -S_j \rVert_1
$$

引入一致反射loss$\mathcal{L}_{ir}$用于对反射的一致性进行约束：
$$
\mathcal{L}_{ir}=\lVert R_{low}-R_{normal} \rVert_1
$$

![Figure 2](2.png 'Figure 2')

### 2.2 Structure-Aware Smoothness Loss
关于光照图的一个基础假设是局部一致性和结构感知性，换句话说，一个好的光照图解应该在纹理细节上是平滑的，同时能够保持全局的结构边界。

总方差最小化(total variation minimization, TV)算法对整张图像的梯度进行最小化操作，它在多种图像修复的任务中用作平滑先验。但是直接使用TV作为loss函数会在当图像有较强结构信息或光照变化剧烈的时候失效。这是因为光照图梯度的均匀减小与该区域具体是纹理细节还是明显的边界无关，也就是说，TV loss无法感知结构信息。因此，光照会变模糊而且反射图中会出现明显的黑色边界，如Figure 2所示。

为了使loss能够感知图片结构，对原始TV loss用反射图的梯度进行加权，最终的$\mathcal{L}_{is}$格式为：
$$
\mathcal{L}_{is}=\sum_{i=low, normal}\lVert \nabla I_i \circ \exp(-\lambda_g \nabla R_i) \rVert
$$
其中$\nabla$代表梯度，包括水平梯度$\nabla_h$和垂直梯度$\nabla_v$, $\lambda_g$是用来平衡结构感知强度的系数。使用权重$\exp(-\lambda_g \nabla R_i)$, $\mathcal{L}_{is}$在反射图梯度较陡的地方放松对平滑度的约束，或者说是在图像结构明显和光照应该不连续的地方放松对平滑度的约束。

尽管LIME算法也考虑在光照图中使用加权TV约束以保留图像的结构信息，但是我们主张这两种方法是不同的。对于LIME算法，TV约束使用一个初始光照图进行加权，它的三通道像素强度都为最大。本文提出的结构感知平滑loss则根据反射进行加权。LIME中使用的固定初始估计也许无法像反射图一样能够描述图像结构信息，因为原理上假设反射图代表了图像的物理属性。由于Decom-Net是离线训练的，所以光照和作为权重的反射图在训练阶段可以同时更新。

## 2.3 Multi-Scale Illumination Adjustment
光照增强网络采用encoder-decoder结构，并引入多尺度拼接用来校正层次视角的光照，如Figure 1所示。

Encoder-decoder结构用于在较大区域中获取上下文信息，然后输入图片会下采样到一个较小的尺度，这样网络可以在光照分布上有一个较大的视野，为网络带来了适应性校正的能力。上采样模块使用大尺度光照信息对局部光照分布进行重建。

要对光照进行层次调整，意味着保持全局光照一致性的同时对不同的局部光照分布进行特异性调整，因此引入多尺度拼接。假设有M个渐进上采样blocks，每个都提取一个C通道特征图，使用近邻插值将这些不同尺寸的特征resize到最终尺寸并将它们拼接成一个$C\times M$通道的特征图。然后用一个1\*1conv将这个特征图降到C通道，然后用3\*3 conv重建光照图$\tilde{I}$


### 2.4 Denoising on Reflectance
